# **AWS KMS** üîë

**AWS Key Management Service (KMS)** is a fully managed service that helps you create and manage cryptographic keys used to encrypt data. It simplifies encryption management by integrating with a variety of AWS services, ensuring your data is securely encrypted and easily accessible when needed.

In this topic, we‚Äôll dive into **how AWS KMS works**, **its features**, **key types**, and **how to effectively use KMS for encryption and compliance**.

## **What is AWS KMS?** üîí

**AWS Key Management Service (KMS)** allows you to **create, store, and manage encryption keys**. It provides centralized control over your cryptographic keys, ensuring they are used securely and comply with regulations.

### **Key Features of AWS KMS:**

- **Compliant**: AWS KMS is **FIPS 140-2** compliant, meeting federal standards for cryptographic operations.
- **Highly Available & Durable**: KMS is built to be **highly available**, offering durable key storage across multiple AWS regions.
- **Integrated with AWS Services**: KMS integrates seamlessly with many AWS services like **S3**, **EBS**, **RDS**, and more, simplifying the encryption of data across your AWS workloads.
- **CloudTrail Integration**: KMS integrates with **AWS CloudTrail** to provide **audit logs** for compliance and monitoring, allowing you to track key usage.
- **Cost**: It costs **\$1/month** for each key you create, with **no charge** for keys created by AWS services.

## **KMS Keys: The Heart of AWS KMS** üîë

KMS keys are the core resource in AWS KMS, and they can be used to perform **encryption** and **decryption** tasks. Here‚Äôs how KMS keys work:

- **Symmetric Keys**: AWS recommends using **symmetric keys** wherever possible. These keys are ideal for encrypting and decrypting data in AWS services.
- **Asymmetric Keys**: KMS also supports **asymmetric keys**, which use a **public-private key pair** for encryption and decryption (often used for digital signatures or key exchanges).
- **Key Usage**: KMS allows **AWS services**, **users**, and **applications** with **IAM roles** to request keys, making it easy to integrate encryption into your workflows.

## **Who Can Create KMS Keys**

![Symmetric Key Operations](images/kms-keys.png)

1. IAM User
1. IAM Role
1. AWS Services (such as EBS Service)

## **KMS Key Operations** üöÄ

### **Encrypting Data with KMS Keys**

- **KMS encrypts data up to 4 KB** in size. For larger datasets, the encryption must be handled by the application itself.
- **Envelope Encryption**: This method involves using KMS to generate a **data key** (symmetric), which is used to encrypt the data. The **data key** is then encrypted with a **master key** in KMS.

### **Key Storage and Security**

- KMS keys never leave the **KMS environment**. Only the **encrypted data** (and encrypted keys) are passed outside of KMS, ensuring high security.
- AWS KMS does **not store customer data** but securely stores the **encryption keys** and ensures they are accessible when needed.

## **AWS Managed vs. Customer Managed KMS Keys** üõ†Ô∏è

AWS provides two types of KMS keys for different use cases: **AWS Managed KMS Keys** and **Customer Managed KMS Keys**.

### **AWS Managed KMS Keys:**

- **Created and managed** by AWS services for you.
- Automatically managed and rotated by AWS.
- Best for customers who prefer not to manage key lifecycle themselves.

### **Customer Managed KMS Keys:**

- **Created, managed, and rotated** by the customer.
- Customers have full control over the lifecycle of these keys, including the ability to **delete**, **rotate**, and **grant access**.
- Provides **greater flexibility** and control.

### **KMS Key Comparison: Managed vs. Customer Managed**

| **Feature**                            | **AWS Managed KMS Key** | **Customer Managed KMS Key**      |
| -------------------------------------- | ----------------------- | --------------------------------- |
| **Customer can view Key metadata**     | Yes                     | Yes                               |
| **Customer can Manage KMS Key**        | No                      | Yes                               |
| **Used only for the customer account** | Yes                     | Yes                               |
| **Automatic rotation of keys**         | Required every 3 years  | Optional - every 1 year if chosen |

## **Encrypt and Decrypt Lifecycle in KMS** üîëüîê

**Example: Encrypting an EBS Volume Using KMS:**

1. You create a **symmetric KMS key** in AWS KMS.
2. You launch an **EC2 instance** with an **EBS root volume** and choose **EBS encryption** using the KMS key.
3. **EBS** uses the KMS key to **generate a data key**, encrypt the data, and store the **encrypted data key**.
4. When the EC2 instance reads from the EBS volume, **EBS** sends the **encrypted data key** to **KMS**, which decrypts it and returns the decrypted key to **EBS**.
5. **EBS** uses the decrypted data key to **decrypt** the data on the volume and provides it to the EC2 instance.

   ![encrypt and decrypt lifecycle in kms](images/encrypt-and-decrypt-lifecycle-in-kms.png)

### **1. Create a KMS Key**

- **KMS (Key Management Service)**: You start by creating a **symmetric KMS key**. This key will be used for encrypting and decrypting the data.
- You can create this key via the **AWS KMS Console** or using the **AWS CLI**.

### **2. Encrypt the EBS Volume with the KMS Key**

- **EBS (Elastic Block Store)**: When you create a new **EBS volume** (or an **EC2 instance** with an **EBS root volume**), you can choose to encrypt the volume.
  - **EBS** uses the **KMS key** to generate a **data key** (a symmetric key) for the encryption process.
  - **EBS** then uses the **data key** to **encrypt the data** on the volume.
  - **EBS** stores the **encrypted data key** alongside the data (on the volume), but the key itself is encrypted using the **KMS key**.

### **3. Decrypting the Data**

- When the **EC2 instance** needs to read the encrypted **EBS volume**:
  1. **EBS** sends the **encrypted data key** to **KMS** to decrypt it.
  2. **KMS** uses the **symmetric KMS key** to decrypt the **encrypted data key**.
  3. **EBS** receives the decrypted **data key** from **KMS** and uses it to **decrypt the actual data** stored on the volume.

### **4. Writing Data Back to the Volume**

- When the EC2 instance writes data back to the encrypted **EBS volume**:
  1. **EBS** uses the **decrypted data key** to **encrypt** the new data before storing it on the volume.
  2. **EBS** then re-encrypts the **data key** using the **KMS key** and stores the re-encrypted version of the data key alongside the data.

### **5. Access Control via IAM**

- **IAM (Identity and Access Management)**: You define who can **access and manage** the KMS key using IAM roles and policies. Only services or users with the correct permissions can use the KMS key to perform encryption or decryption tasks.

### **Summary of Roles:**

1. **KMS (Key Management Service)**:

   - Manages the **symmetric KMS key**.
   - **Decrypts the data key** (used by EBS to encrypt/decrypt data).
   - Provides the **encrypted data key** to **EBS**.

2. **EBS (Elastic Block Store)**:

   - **Encrypts** and **decrypts** the data using the **data key**.
   - Uses **KMS** to obtain the **encrypted data key** and decrypt it.
   - Handles the actual **encryption/decryption** of the data on the volume.

3. **IAM (Identity and Access Management)**:
   - Controls **access permissions** for who can use the **KMS key** and interact with the EBS volume.

## **Best Practices for Using AWS KMS** üìä

1. **Use KMS for Centralized Key Management**:
   - Leverage **AWS KMS** for creating and managing your encryption keys across AWS services.
2. **Rotate Keys Regularly**:
   - Regular key rotation helps ensure **key longevity** and **security**. For Customer Managed KMS Keys, rotating them annually is a best practice.
3. **Use IAM Policies for Fine-Grained Access Control**:
   - Set up **IAM roles** and **policies** to control who can access and use the KMS keys, ensuring that only authorized users and services can perform encryption and decryption tasks.
4. **Enable CloudTrail for Auditing**:
   - Integrate with **CloudTrail** to monitor key usage, providing important audit trails for compliance and security.
5. **Use Multi-Region Keys for Global Applications**:
   - **Multi-region KMS keys** allow you to **replicate** your keys across different regions, ensuring your data is encrypted and accessible no matter where it‚Äôs stored.

## **Conclusion: Simplifying Key Management with AWS KMS** üîë

**AWS KMS** is an essential service for managing cryptographic keys securely and efficiently in the cloud. By offering **symmetric** and **asymmetric keys**, KMS simplifies encryption and decryption tasks while ensuring compliance with security standards.

- **AWS Managed Keys** are great for automated management, while **Customer Managed Keys** give you more control over your key lifecycle.
- By using **KMS** with other AWS services like **S3**, **RDS**, and **EBS**, you can encrypt data seamlessly while adhering to best security practices.
