# **Upgrading a Kubernetes Cluster**

## **Overview of Cluster Upgrades**

1. **Purpose of Upgrading:**

   - Improve security, performance, and stability.
   - Gain access to new features and bug fixes.
   - Ensure compatibility with other tools and dependencies.

2. **Types of Upgrades:**
   - **Control Plane Upgrade:** Upgrading the Kubernetes master components (API server, scheduler, controller manager).
   - **Worker Node Upgrade:** Upgrading the nodes running your application workloads.

## **Pre-Upgrade Preparation**

1. **Review Release Notes:**

   - **Action:** Check Kubernetes release notes for the version you are upgrading to.
   - **Resource:** [Kubernetes Release Notes](https://kubernetes.io/docs/setup/release/notes/)

2. **Backup Data:**

   1. **etcd Backup:**
   1. **Backup Kubernetes Configurations:** Backup manifests, Helm charts, and configurations.

3. **Test the Upgrade:**

   - **Action:** Perform a test upgrade on a staging environment that mirrors your production setup.

4. **Update Dependencies:**
   - **Action:** Ensure all custom controllers, operators, and applications are compatible with the new Kubernetes version.

## **1. Upgrade Control Plane(Master Nodes)**

```bash
# 1.Upgrade `kubeadm`
sudo apt-mark unhold kubeadm
sudo apt-get update && sudo apt-get install -y kubeadm=1.30.4-1.1
sudo apt-mark hold kubeadm
```

```bash
# 2.Plan the Upgrade
kubeadm upgrade plan
```

```bash
# 3.Apply the Upgrade
kubeadm upgrade apply v1.30.4
```

```bash
# 4.Upgrade `kubelet` and `kubectl`
sudo apt-mark unhold kubectl  kubelet
sudo apt-get update && sudo apt-get install -y kubelet=1.30.4-1.1 kubectl=1.30.4-1.1
sudo apt-mark hold kubectl kubelet

sudo systemctl restart kubelet
sudo kubelet --version
```

```txt
Repeat for Each Master Node in the Cluster one by one.
```

```bash
# Verify Control Plane Components
kubectl get nodes
kubectl get pods -n kube-system -o wide
kubectl version
```

## **2. Upgrade Worker Nodes**

```bash
# 1.Drain Node
kubectl drain <node-name> --ignore-daemonsets --delete-emptydir-data
```

```bash
# 2.Upgrade `kubeadm`, `kubelet`, and `kubectl`
sudo apt-mark unhold kubeadm  kubelet
sudo apt-get update && sudo apt-get install -y kubeadm=1.30.4-1.1 kubelet=1.30.4-1.1
sudo apt-mark hold kubeadm kubelet
sudo systemctl restart kubelet
sudo kubelet --version
```

```bash
# 3.Uncordon Node
kubectl uncordon <node-name>
```

```txt
Repeat for Each Worker Node in the Cluster one by one.
```

## **3. Post-Upgrade Tasks**

```bash
# 1.Verify Cluster Health
kubectl get nodes
kubectl get pods --all-namespaces
```

```bash
# 2.Update Helm Repository and Upgrade Charts
helm repo update
helm upgrade <release-name> <chart> --version <new-version>
```

```bash
# 3.Ensure applications are functioning correctly. Check logs for any issues.
```

```bash
# 4.Review Deprecated APIs
kubectl deprecations
```

```bash
# 5.Update deprecated API versions in your manifests
```

## **Rolling Back (if needed)**

```bash
# 1.Restore etcd Backup
ETCDCTL_API=3 etcdctl snapshot restore /path/to/backup.db \
  --data-dir=/var/lib/etcd
```

```bash
# 2.Reinstall Previous Kubernetes Version
sudo apt-get update && \

sudo apt-get install -y \
kubeadm=<previous-version> \
kubelet=<previous-version> \
kubectl=<previous-version>


sudo systemctl restart kubelet
```

## **Additional Best Practices**

1. **Monitor Cluster Logs:**

   Use tools like **Prometheus** and **Grafana** to monitor the health and performance of the cluster during and after the upgrade.

2. **Automate Upgrades:**

   Consider using tools like `kubeadm` automation scripts or third-party tools to streamline the upgrade process.

3. **Document the Upgrade Process:**
   Keep detailed records of the upgrade process, including any issues encountered and resolutions.

## Note

### 1. Drain vs Cordon

In Kubernetes, both `drain` and `cordon` are commands used to prepare a node for maintenance by ensuring that workloads are safely evicted or rescheduled. However, they serve different purposes:

- **Cordon**: This command marks a node as unschedulable, which means no new pods can be scheduled on it. Existing pods on the node are not affected and will continue to run. Use this when you want to prevent new workloads from being placed on the node but do not need to move existing workloads.

- **Drain**: This command not only marks the node as unschedulable (like `cordon`) but also evicts all the pods from the node, except those that are not managed by a controller or those with local storage. The pods will be rescheduled on other nodes in the cluster. Use this when you need to completely clear a node of running workloads, for example, before performing maintenance.

### 2. Drain works only with pods that are managed by a ReplicaSet

The `drain` command will only work with pods that are managed by a ReplicaSet. This is because ReplicaSets track the state of the pods they manage and can automatically recreate a pod if it is terminated or deleted.

When you run `kubectl drain <node-name>`, Kubernetes will:

1. Mark the node as unschedulable.
2. Evict all pods from the node that are managed by a ReplicaSet.
3. The ReplicaSet will detect that the pods are no longer running and will recreate them on other nodes in the cluster.

If you have pods running on a node that are not managed by a ReplicaSet, the `drain` command will not evict them. You will need to delete or manually remove them from the node.
