# etcd Backup and Restore in Kubernetes

etcd is a distributed key-value store that serves as the primary data store for Kubernetes, holding critical cluster data. Backing up and restoring etcd is essential for disaster recovery and ensuring the stability of the Kubernetes cluster.

## Backup Strategies

You can back up etcd in two primary ways:

1. **Snapshot**: A point-in-time backup of the entire etcd data store.
1. **Export**: An export of etcd key-value pairs, typically in JSON format.

## Prerequisites

### 1. Access to the Kubernetes Cluster

Ensure you have access to the Kubernetes cluster where etcd is running. This usually involves:

- A configured `kubectl` context that points to your cluster.
- Appropriate permissions to execute commands in the `kube-system` namespace (where etcd typically resides).

### 2. Tools

Depending on which specific outcome you're working on, you will need the etcdctl tool or the etcdutl tool (you may need both).

`etcdctl` and `etcdutl` are command-line tools used to interact with etcd clusters, but they serve different purposes:

- `etcdctl`: This is the primary command-line client for interacting with etcd over a network. It is used for day-to-day operations such as managing keys and values, administering the cluster, checking health, and more.

- `etcdutl`: This is an administration utility designed to operate directly on etcd data files, including migrating data between etcd versions, defragmenting the database, restoring snapshots, and validating data consistency. For network operations, etcdctl should be used.

### 3. Access to etcd Endpoints

You need to know the endpoints of your etcd cluster, which are typically in the form of `https://<etcd-ip>:<port>`.

If etcd is configured with TLS, youâ€™ll also need:

- The certificate authority (CA) certificate file.
- The client certificate and key files for authentication.

```bash
# Example command to set the endpoints and authentication:
# you can find the paths in /etc/kubernetes/manifiests/etcd.yaml
export ETCDCTL_API=3
export ETCDCTL_CACERT=<path-to-ca-cert>
# e.g., /etc/kubernetes/pki/etcd/ca.crt
export ETCDCTL_CERT=<path-to-client-cert>
# e.g., /etc/kubernetes/pki/etcd/server.crt
export ETCDCTL_KEY=<path-to-client-key>
# e.g., /etc/kubernetes/pki/etcd/server.key
```

- You can find the paths to these files in ~/.minikube

## Backup Process

### a. Backup to a Remote Location

#### Manual Backup

```bash
# 1.Identify the etcd Pod
kubectl get pods -n kube-system | grep etcd
```

```bash
# 2.Take an etcd Snapshot
kubectl exec -n kube-system <etcd-pod-name> -- etcdctl snapshot save /path/to/backup/db

# /path/to/backup/db is the location where the snapshot will be saved within the etcd pod.
```

```bash
# 3.Copy the Snapshot to Local Machine (Optional)
kubectl cp kube-system/<etcd-pod-name>:/path/to/backup/db /path/on/local/machine

# /path/on/local/machine is the local directory where you want to save the snapshot.
```

```bash
# 4.Verify the Backup (Optional)
etcdctl --write-out=table snapshot status /path/to/backup/db
```

#### Automated Backup Script

```yaml
# You can create a CronJob that periodically backs up etcd
# to a specified local location within the etcd pod.
apiVersion: batch/v1
kind: CronJob
metadata:
  name: etcd-backup-local
  namespace: kube-system
spec:
  schedule: "0 * * * *" # (e.g., every hour)
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: etcd-backup
              image: bitnami/etcd:latest
              command: ["/bin/sh", "-c"]
              args:
                - |
                  etcdctl snapshot save /backup/db
                  # Additional commands to copy the backup locally or perform cleanup
          restartPolicy: OnFailure
```

### b. Backup to a Remote Location (AWS S3)

#### Manual Backup

```md
0. **Set Up IAM Permissions**
   Ensure that the IAM role associated with your Kubernetes nodes has permissions to write to the specified S3 bucket.
```

```bash
# 1.Identify the etcd Pod
kubectl get pods -n kube-system | grep etcd
```

```bash
# 2.Take an etcd Snapshot
kubectl exec -n kube-system <etcd-pod-name> -- etcdctl snapshot save /tmp/backup.db
```

```bash
# 3.Copy the Snapshot to AWS S3
kubectl exec -n kube-system <etcd-pod-name> -- aws s3 cp /tmp/backup.db s3://your-bucket-name/path/to/backup.db

# ensure that the AWS CLI is installed in the pod or a sidecar container that has access to the snapshot. If it's not installed, you may need to copy the snapshot to your local machine first and then upload it to S3.

# Replace `your-bucket-name` with your S3 bucket name and `/path/to/backup.db` with the desired S3 path.
```

#### Automated Backup Script

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: etcd-backup-s3
  namespace: kube-system
spec:
  schedule: "0 * * * *" # Adjust the schedule as needed
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: etcd-backup
              image: bitnami/etcd:latest
              command: ["/bin/sh", "-c"]
              args:
                - |
                  # Take snapshot
                  etcdctl snapshot save /tmp/backup.db

                  # Copy snapshot to S3
                  aws s3 cp /tmp/backup.db s3://your-bucket-name/path/to/backup/db

                  # Optional: Clean up old backups locally
          env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: aws-secret
                  key: access-key
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: aws-secret
                  key: secret-key
            - name: AWS_REGION
              value: your-aws-region # e.g., us-west-2
          restartPolicy: OnFailure
```

## Restore Process

### a. Restore from a Local Location

#### Manual Restore

```bash
# 1.Access the etcd Pod
kubectl exec -n kube-system <etcd-pod-name> -- sh
```

```bash
# 2.Restore the Snapshot
etcdctl snapshot restore /path/to/backup/db --data-dir /var/lib/etcd
```

```bash
# 3.Restart the etcd Pod
kubectl delete pod <etcd-pod-name> -n kube-system
```

```bash
# 4.Verify the Restore
etcdctl endpoint health
```

#### Automated Restore Script

```yaml
#!/bin/bash

# Set variables
LOCAL_SNAPSHOT="/path/to/backup.db"  # Update with the path to your local snapshot
ETCD_POD_NAME="etcd-<pod-name>"  # Replace with your actual etcd pod name

# Restore the snapshot
echo "Restoring snapshot from local location to etcd..."
kubectl exec -n kube-system $ETCD_POD_NAME -- etcdctl snapshot restore $LOCAL_SNAPSHOT --data-dir /var/lib/etcd

# Restart the etcd pod to apply changes
echo "Restarting etcd pod..."
kubectl delete pod $ETCD_POD_NAME -n kube-system

echo "Restore process completed."
```

### b. Restore from a Remote Location (AWS S3)

#### Manual Restore

```bash
# 1.Access the etcd Pod
kubectl exec -n kube-system <etcd-pod-name> -- sh
```

```bash
# 2.Copy the Snapshot from S3
# Ensure that the AWS CLI is installed and configured in the etcd pod.
aws s3 cp s3://your-bucket-name/path/to/backup.db /tmp/backup.db
```

```bash
# 3.Restore the Snapshot
etcdctl snapshot restore /tmp/backup.db --data-dir /var/lib/etcd
```

```bash
# 4.Restart the etcd Pod
kubectl delete pod <etcd-pod-name> -n kube-system
```

```bash
# 5.Verify the Restore
etcdctl endpoint health
```

#### Automated Restore Script

```yaml
#!/bin/bash

# Set variables
S3_BUCKET="your-bucket-name"  # Update with your S3 bucket name
S3_PATH="path/to/backup.db"    # Update with the S3 path to your backup
LOCAL_SNAPSHOT="/tmp/backup.db"  # Local temporary path to store the snapshot
ETCD_POD_NAME="etcd-<pod-name>"  # Replace with your actual etcd pod name

# Download the snapshot from S3
echo "Downloading snapshot from S3..."
kubectl exec -n kube-system $ETCD_POD_NAME -- aws s3 cp s3://$S3_BUCKET/$S3_PATH $LOCAL_SNAPSHOT

# Restore the snapshot
echo "Restoring snapshot to etcd..."
kubectl exec -n kube-system $ETCD_POD_NAME -- etcdctl snapshot restore $LOCAL_SNAPSHOT --data-dir /var/lib/etcd

# Restart the etcd pod to apply changes
echo "Restarting etcd pod..."
kubectl delete pod $ETCD_POD_NAME -n kube-system

echo "Restore process completed."
```
