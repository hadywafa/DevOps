# Iptables

**iptables** is a user-space utility program that allows a system administrator to configure the IP packet filter rules of the Linux kernel firewall. Itâ€™s part of the netfilter project, which provides various functionalities for packet filtering, network address translation (NAT), and more.
![alt text](images/iptables-1.png)

## **Common Use Cases**

- **Securing a Server**: Blocking unwanted traffic and allowing only necessary services (e.g., SSH, HTTP).

- **Network Address Translation (NAT)**: Sharing a single IP address among multiple devices on a local network.

- **Traffic Shaping and Filtering**: Limiting bandwidth or blocking specific types of traffic.

- **Load Balancing**: Distributing incoming network traffic across multiple servers to improve performance and reliability.

- **Port Forwarding**: Redirecting incoming network traffic from one port to another, allowing access to services behind a firewall or NAT.

## **Basic Concepts**

### **Tables**

iptables organizes rules into tables. Each table has a specific purpose:

- **Filter**: The default table for general packet filtering.
- **NAT**: Used for network address translation (e.g., for IP masquerading).
- **Mangle**: Used for specialized packet alterations.
- **Raw**: Used for exemptions from connection tracking.

### **Chains**

- packets are processed through chains which are lists of rules.

- When a packet matches a rule in a chain, a specific action (target) is taken. Common chains include:
  - **INPUT**: For incoming packets destined for the local system.
  - **FORWARD**: For packets being routed through the system.
  - **OUTPUT**: For outgoing packets from the local system.
  - **PREROUTING**: For packets as they arrive on an interface.
  - **POSTROUTING**: For packets as they leave an interface.
  - **<CUSTOM_CHAIN>**: custom chains can be defined to group rules for specific purposes.

### **Rules**

**iptables** operates by defining rules that control the flow of network traffic. These rules are applied to packets as they traverse the network stack, allowing or denying traffic based on various criteria.

- Rules define the criteria for matching packets and the action to be taken (e.g., ACCEPT, DROP). Rules can be based on various attributes like source/destination IP, port numbers, and protocols.
  ![alt text](images/chain-rules.png)
- TARGET is executed when traffic matches these rules.

### **Targets**

The action to be taken when a packet matches a rule. Common targets include:

- **ACCEPT**: Allow the packet through.
- **DROP**: Discard the packet.
- **RETURN**: Stop processing the current chain and return to the previous one.
- **REJECT**: Discard the packet and send an error message.
- **LOG**: Log the packet details.
- **REDIRECT**: Redirect the packet to a different port or IP address.
- **MASQUERADE**: Modify the source IP address for NAT.
- **DNAT**: Change the destination address of the packet.
- **SNAT**: Change the source address of the packet.
- **MARK**: Set a mark value for the packet.
- **<CUSTOM_CHAIN>**: Jump to a user-defined chain.

## **Basic Commands**

### Command

- **View Rules**  
  To list the current rules in a specific table:

  ```bash
  sudo iptables -L          # List all rules in the filter table
  sudo iptables -t nat -L   # List all rules in the NAT table
  ```

- **Add Rules**  
  To add a new rule:

  ```bash
  sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT   # Allow incoming SSH
  ```

- **Delete Rules**  
  To delete a rule:

  ```bash
  sudo iptables -D INPUT -p tcp --dport 22 -j ACCEPT   # Remove SSH rule
  ```

- **Save Rules**  
  To save rules so they persist across reboots:

  ```bash

  sudo iptables-save > /etc/iptables/rules.v4
  ```

### Common Command

## Examples

### 1. Redirect Port 80 to 8080

![alt text](example-redirect-port.png)

```bash
# Redirect port 80 to 8080
sudo iptables \
--table nat \
--append PREROUTING \
--protocol tcp \
--dport 80 \
--jump REDIRECT \
--to-port 8080
```

### 2. DNAT Forwarding To Another Machine

![alt text](images/example-redirect-request-1.png)
![alt text](images/example-redirect-request-2.png)
![alt text](images/example-redirect-request-3.png)
![alt text](images/example-redirect-request-4.png)

```bash
# 1.Prerouting chain is used to change the destination address of the packet.
sudo iptables \
--table nat \
--append PREROUTING \
--protocol tcp \
--destination 192.168.1.5 \
--dport 80 \
--jump DNAT \
--to-destination 192.168.1.6:8080
```

```bash
# 2.Postrouting chain is used to change the source address of the packet.
sudo iptables \
--table nat \
--append POSTROUTING \
--protocol tcp \
--destination 192.168.1.6 \
--dport 8080 \
--jump SNAT \
--to-source 192.168.1.5
```

```bash
# 3. enable ip forwarding
sudo sysctl -w net.ipv4.ip_forward=1
```

## Notes

- **Check for Syntax Errors**  
  Ensure rules are correctly formatted to avoid unexpected behaviors.

- **Documentation and Help**  
  Use the `man` command for detailed documentation:
  ```bash
  man iptables
  ```

* **nftables**  
  A modern replacement for `iptables` with improved features and performance.
