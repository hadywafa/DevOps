# Network Namespaces and Virtual Ethernet Interface (veth)

Network namespaces are a feature of the Linux kernel that allows for the creation of multiple isolated network stacks. Each network namespace can have its own network devices, IP addresses, routing tables, and firewall rules. This allows for the creation of isolated network environments within a single host.

Virtual Ethernet interfaces (veth) are a pair of virtual network interfaces that are used to connect two network namespaces. One end of the veth pair is placed in one network namespace, while the other end is placed in another network namespace. This allows for communication between processes running in different network namespaces.

When a container is created, a new network namespace is created for the container. A veth pair is then created, with one end placed in the container's network namespace and the other end placed in the host's network namespace. This allows the container to communicate with the host and other containers on the same host.

By using network namespaces and veth pairs, containers can be isolated from each other and from the host system, while still being able to communicate with each other and the outside world.

## Key Points

- Network namespaces allow for the creation of isolated network environments within a single host.
- Virtual Ethernet interfaces (veth) are used to connect network namespaces.
- Containers use network namespaces and veth pairs to communicate with each other and the host system.

## Examples

Network namespaces and veth pairs are implemented in the Linux kernel. Tools like `ip netns` and `ip link` can be used to create and manage network namespaces and veth pairs.

### Example in Same Subnet(Switch)

![alt text](image.png)

#### 1.Define variables

> Node 1

```bash
NODE1_IP="192.168.1.5"

# Bridge variables
NODE1_BR0_SUB="172.16.0.0/24"
NODE1_BR_IP="172.16.0.1"

# Namespaces variables
NODE1_NS1="NS1"
NODE1_NS1_IP="172.16.0.2"
NODE1_NS2="NS2"
NODE1_NS2_IP="172.16.0.3"
```

> Node 2

```bash
NODE2_IP="192.168.1.6"

# Bridge variables
NODE2_BR0_SUB="172.16.1.0/24"
NODE2_BR0_IP="172.16.1.1"

# Namespaces variables
NODE2_NS1="NS1"
NODE2_NS1_IP="172.16.1.2"
NODE2_NS2="NS2"
NODE2_NS2_IP="172.16.1.3"
```

#### 2.Create namespaces

```bash
# Node 1
sudo ip netns add $NODE1_NS1
sudo ip netns add $NODE1_NS2
```

```bash
# Node 2
sudo ip netns add $NODE2_NS1
sudo ip netns add $NODE2_NS2
```

#### 3.Create veth pairs

```bash
# Node 1
sudo ip link add veth10 type veth peer name veth11
sudo ip link add veth20 type veth peer name veth21
```

```bash
# Node 2
sudo ip link add veth10 type veth peer name veth11
sudo ip link add veth20 type veth peer name veth21
```

#### 4.link veth pairs to namespaces

```bash
# Node 1
sudo ip link set veth11 netns $NODE1_NS1
sudo ip link set veth21 netns $NODE1_NS2
```

```bash
# Node 2
sudo ip link set veth11 netns $NODE2_NS1
sudo ip link set veth21 netns $NODE2_NS2
```

#### 5.assign ip address to veth interface

```bash
# Node 1
ip netns exec $NODE1_NS1 ip addr add $NODE1_NS1_IP/24 dev veth11
ip netns exec $NODE1_NS2 ip addr add $NODE1_NS2_IP/24 dev veth21
```

```bash
# Node 2
ip netns exec $NODE2_NS1 ip addr add $NODE2_NS1_IP/24 dev veth11
ip netns exec $NODE2_NS2 ip addr add $NODE2_NS2_IP/24 dev veth21
```

#### 6.enable veth inside namespaces

```bash
# Node 1
ip netns exec $NODE1_NS1 ip link set dev veth11 up
ip netns exec $NODE1_NS2 ip link set dev veth21 up
```

```bash
# Node 2
ip netns exec $NODE2_NS1 ip link set dev veth11 up
ip netns exec $NODE2_NS2 ip link set dev veth21 up
```

#### 7.Create bridges

```bash
# Node 1
sudo ip link add br0 type bridge
```

```bash
# Node 2
sudo ip link add br0 type bridge
```

#### 8.link veth pairs to bridges

```bash
# Node 1
# ================== NS 1 ==================
sudo ip link set veth10 master br0
sudo ip link set veth20 master br0

# ================== NS 2 ==================
sudo ip link set veth10 master br0
sudo ip link set veth20 master br0
```

```bash
# Node 2
# ================== NS 1 ==================
sudo ip link set veth10 master br0
sudo ip link set veth20 master br0

# ================== NS 2 ==================
sudo ip link set veth10 master br0
sudo ip link set veth20 master br0
```

#### 9.assign IP address to bridges

```bash
# Node 1 && Node 2
sudo ip addr add $NODE1_BR_IP/24 dev br0
sudo ip link set dev br0 up
```

#### 10.enable veth inside bridges

```bash
# Node 1 && Node 2
sudo ip link set dev veth10 up
sudo ip link set dev veth20 up
```

#### 11.configure the loopback interfaces in the namespaces

```bash
# Node 1
ip netns exec $NODE1_NS1 ip link set lo up
ip netns exec $NODE1_NS2 ip link set lo up
```

```bash
# Node 2
ip netns exec $NODE2_NS1 ip link set lo up
ip netns exec $NODE2_NS2 ip link set lo up
```

#### 12.Configure default route for the namespaces

```bash
# Node 1
# if any packet in NS1 needs to go to bridge it should talk veth11 by default
ip netns exec $NODE1_NS1 ip route add default via $NODE1_BR_IP dev veth11
# if any packet in NS2 needs to go to bridge it should talk veth21 by default
ip netns exec $NODE1_NS2 ip route add default via $NODE1_BR_IP dev veth21
```

```bash
# Node 2
ip netns exec $NODE2_NS1 ip route add $NODE2_BR_IP via dev veth11
ip netns exec $NODE2_NS2 ip route add $NODE2_BR_IP via dev veth21
```

#### 13.Configure Node1 routes for connect to Node2

```bash
sudo ip route add $NODE2_BR0_SUB via $NODE2_BR_IP dev eth0
```

#### 14.Configure Node2 routes for connect to Node1

```bash
sudo ip route add $NODE1_BR0_SUB via $NODE1_BR_IP dev eth0
```

#### 15.enable ip forwarding

```bash
# Node 1 && Node 2
sudo sysctl -w net.ipv4.ip_forward=1
```

#### 16.Configure iptables

```bash
# Node 1
ip netns exec $NODE1_NS1 iptables -t nat -A POSTROUTING -o br0 -j MASQUERADE
ip netns exec $NODE1_NS2 iptables -t nat -A POSTROUTING -o br0 -j MASQUERADE
```

```bash
# Node 2
ip netns exec $NODE1_NS1 iptables -t nat -A POSTROUTING -o br0 -j MASQUERADE
ip netns exec $NODE1_NS2 iptables -t nat -A POSTROUTING -o br0 -j MASQUERADE
```

#### 17.Test connectivity

```bash
# Node 1
ip netns exec $NODE1_NS1 ping -c 3 $NODE1_NS2_IP
```

```bash
# Node 2
ip netns exec $NODE1_NS1 ping -c 3 $NODE1_NS2_IP
```

#### 18.Clean up

```bash
# Node 1
ip netns del $NODE1_NS1
ip netns del $NODE1_NS2
```

```bash
# Node 2
ip netns del $NODE1_NS1
ip netns del $NODE1_NS2
```

### Example in Different Subnet(Router)

![alt text](image-1.png)

## Notes

- Network namespaces and veth pairs are used to create isolated network environments within a single host.
- Containers use network namespaces and veth pairs to communicate with each other and the host system.
- Tools like `ip netns` and `ip link` can be used to create and manage network namespaces and veth pairs.
