# Monitor your own application with Prometheus

![alt text](../images/monitor-own-app-1.png)
![alt text](../images/monitor-own-app-2.png)

## Monitoring Your Own Application with Prometheus in .NET

To monitor your .NET application using Prometheus, you can use the Prometheus .NET client library to expose metrics. Hereâ€™s a step-by-step guide to set up a simple ASP.NET Core API with Prometheus metrics, focusing on total requests and request duration.

### Steps to Monitor a .NET Application with Prometheus

1. **Setup ASP.NET Core Application with Prometheus Metrics**
1. **Create Dockerfile**
1. **Build and Push Docker Image**
1. **Create Kubernetes Deployment and Service**
1. **Create a ServiceMonitor**
1. **Expose the Application using Port-Forward**
1. **Verify Prometheus Configuration**
1. **Add a Dashboard in Grafana**
1. **Testing**

### 1. Setup ASP.NET Core Application with Prometheus Metrics

Create a new ASP.NET Core application and add Prometheus metrics.

**Program.cs:**

```csharp
using Microsoft.AspNetCore.Builder;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Prometheus;
using System.Diagnostics;
using System.Threading.Tasks;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddControllers();

var app = builder.Build();

// Middleware to track request metrics
app.Use(async (context, next) =>
{
    var stopwatch = Stopwatch.StartNew();
    try
    {
        await next.Invoke();
    }
    finally
    {
        stopwatch.Stop();
        Metrics.CreateCounter("http_requests_total", "Total number of HTTP requests.").Inc();
        Metrics.CreateHistogram("http_request_duration_seconds", "The duration of HTTP requests processed in seconds.")
               .Observe(stopwatch.Elapsed.TotalSeconds);
    }
});

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseDeveloperExceptionPage();
}
else
{
    app.UseExceptionHandler("/Home/Error");
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();
app.UseRouting();
app.UseAuthorization();

// Add Prometheus metrics endpoint
app.MapControllers();
app.MapMetrics(); // Maps the /metrics endpoint for Prometheus

app.MapGet("/test/exception", () =>
{
    throw new Exception("Test exception");
});

app.MapGet("/test/success", () =>
{
    return Results.Ok("This is a successful response.");
});

app.Run();
```

### 2. Create Dockerfile

Create a `Dockerfile` for your application:

```Dockerfile
# Use the official .NET 6 SDK image to build the application
FROM mcr.microsoft.com/dotnet/sdk:6.0 AS build
WORKDIR /app
COPY . ./
RUN dotnet restore
RUN dotnet publish -c Release -o /app/publish

# Use the official .NET 6 runtime image to run the application
FROM mcr.microsoft.com/dotnet/aspnet:6.0
WORKDIR /app
COPY --from=build /app/publish .
ENTRYPOINT ["dotnet", "SimpleApi.dll"]
```

### 3. Build and Push Docker Image

Build the Docker image and push it to a container registry (e.g., Docker Hub):

```bash
docker build -t your-username/simpleapi:latest .
docker push your-username/simpleapi:latest
```

### 4. Create Kubernetes Deployment and Service

Create a Kubernetes deployment and service configuration in `simpleapi-deployment.yaml`:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simpleapi
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simpleapi
  template:
    metadata:
      labels:
        app: simpleapi
    spec:
      containers:
        - name: simpleapi
          image: your-username/simpleapi:latest
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: simpleapi
  labels:
    app: simpleapi
spec:
  selector:
    app: simpleapi
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
```

Apply the configuration:

```bash
kubectl apply -f simpleapi-deployment.yaml
```

### 5. Create a ServiceMonitor

Create a `ServiceMonitor` to configure Prometheus to scrape the `/metrics` endpoint of your application. Save the following YAML configuration as `simpleapi-servicemonitor.yaml`:

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: simpleapi
  labels:
    release: prometheus
spec:
  selector:
    matchLabels:
      app: simpleapi
  endpoints:
    - port: 80
      path: /metrics
      interval: 15s
```

Apply the `ServiceMonitor` configuration:

```bash
kubectl apply -f simpleapi-servicemonitor.yaml
```

### 6. Expose the Application using Port-Forward

Forward a local port to the Kubernetes service:

```bash
kubectl port-forward service/simpleapi 5000:80
```

You can now access your application at `http://localhost:5000`.

### 7. Verify Prometheus Configuration

1. **Access Prometheus**:

   Port-forward the Prometheus service to access it locally:

   ```bash
   kubectl port-forward svc/prometheus-kube-prometheus-prometheus 9090:9090
   ```

   Access Prometheus at `http://localhost:9090`.

2. **Check Targets**:

   In Prometheus, navigate to `Status` -> `Targets` to verify that your `simpleapi` target is being scraped.

### 8. Add a Dashboard in Grafana

1. **Access Grafana**:

   Port-forward the Grafana service to access it locally:

   ```bash
   kubectl port-forward svc/prometheus-grafana 3000:80
   ```

   Access Grafana at `http://localhost:3000`.

2. **Add Prometheus as a Data Source**:

   - Go to `Configuration` -> `Data Sources`.
   - Click `Add data source`.
   - Choose `Prometheus` and set the URL to `http://prometheus-kube-prometheus-prometheus.default.svc:9090`.
   - Click `Save & Test`.

3. **Create a Dashboard**:

   - Go to `Create` -> `Dashboard`.
   - Add a new panel and choose `Prometheus` as the data source.
   - Enter a Prometheus query like `http_exceptions_total` to see metrics about exceptions from your application.

### 9. Testing

- Navigate to `http://localhost:5000/test/exception` to trigger the exception.
- Check Prometheus and Grafana to see the metrics and any potential errors logged from your application.
